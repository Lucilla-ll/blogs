# ä¼˜åŒ–å‰ç«¯å¼‚æ­¥è„šæœ¬ä¾èµ–åŠ è½½ï¼šä»¥ `window.__userGEO` ä¸ºä¾‹çš„æœ€ä½³å®è·µ

åœ¨å¤šè¯­è¨€ç«™ç‚¹æˆ–ä¾èµ–åœ°ç†å®šä½çš„å‰ç«¯é¡¹ç›®ä¸­ï¼Œ**é€šè¿‡å¼‚æ­¥è„šæœ¬å¼•å…¥ç”¨æˆ·ä½ç½®æ•°æ®åå†æ‰§è¡Œé€»è¾‘å¤„ç†**æ˜¯ä¸€ç§å¸¸è§æ¨¡å¼ã€‚

æœ¬æ–‡ä»¥å¦‚ä¸‹åœºæ™¯ä¸ºä¾‹å±•å¼€ä¼˜åŒ–åˆ†æï¼š

> ç›®æ ‡ï¼š**åœ¨ location è„šæœ¬è¿”å›ç”¨æˆ·ä½ç½®æ•°æ®åï¼Œç«‹å³è¯»å– `window.__userGEO?.company` å¹¶è¿›è¡Œé€»è¾‘æ§åˆ¶**ï¼Œè€Œä¸æ˜¯ç­‰å¾… `DOMContentLoaded`ã€‚

---

## åœºæ™¯èƒŒæ™¯

æˆ‘ä»¬æ­£åœ¨å¼€å‘ä¸€ä¸ªä½¿ç”¨ Astro çš„å¤šè¯­è¨€ç«™ç‚¹ï¼š

```astro
<script define:vars={{ lang }}>
  document.addEventListener('DOMContentLoaded', function () {
    let company = window.__userGEO?.company || 'company1'
    if (company !== 'company1' && company !== 'company2') {
      window.location.href = 'https://www.mywonderfulsite.com/'
    }

    const scriptElement = document.createElement('script')
    scriptElement.type = 'text/javascript'
    scriptElement.src = '/rw.js'
    scriptElement.setAttribute('company', company)
    scriptElement.setAttribute('lang', lang)
    document.head.appendChild(scriptElement)
  })
</script>
```

### âŒ é—®é¢˜

* `window.__userGEO` æ˜¯ç”± `https://www.mywonderfulsite.com/api/location` è„šæœ¬åŠ¨æ€æ³¨å…¥çš„ã€‚
* å½“å‰é€»è¾‘ä¾èµ– `DOMContentLoaded`ï¼Œä½† `__userGEO` ä¸ä¸€å®šæ­¤æ—¶å°±å·²å¯ç”¨ã€‚
* å­˜åœ¨æ½œåœ¨ race conditionï¼Œå¯èƒ½å¯¼è‡´è·³è½¬/è„šæœ¬åŠ è½½å¤±æ•ˆã€‚

---

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

* **åœ¨ location è„šæœ¬æ‰§è¡Œå®Œæ¯•åç«‹å³è¿è¡Œåç»­é€»è¾‘**
* **æå‡é¡µé¢åˆå§‹åŒ–é€Ÿåº¦**
* **å¢å¼ºè„šæœ¬æ‰§è¡Œçš„æ—¶æœºæ§åˆ¶å’Œç¨³å®šæ€§**

---

## âœ… ä¼˜åŒ–æ–¹å¼ä¸€ï¼šä½¿ç”¨ `<script>.onload` ç²¾å‡†æ§åˆ¶ä¾èµ–

è¿™æ˜¯æœ€æ¨èçš„æ–¹å¼ä¹‹ä¸€ â€”â€” æ˜ç¡®æ§åˆ¶è„šæœ¬åŠ è½½é¡ºåºï¼š

```html
<script define:vars={{ lang }}>
  const locationScript = document.createElement('script')
  locationScript.src = 'https://www.mywonderfulsite.com/api/location'
  locationScript.onload = function () {
    const company = window.__userGEO?.company || 'company1'
    if (company !== 'company1' && company !== 'company2') {
      window.location.href = 'https://www.mywonderfulsite.com/'
      return
    }

    const scriptElement = document.createElement('script')
    scriptElement.type = 'text/javascript'
    scriptElement.src = '/rw.js'
    scriptElement.setAttribute('company', company)
    scriptElement.setAttribute('lang', '{{ lang }}')
    document.head.appendChild(scriptElement)
  }
  document.head.appendChild(locationScript)
</script>
```

### âœ… ä¼˜ç‚¹ï¼š

* é¡ºåºå¯æ§ï¼Œæ€§èƒ½ä¼˜äº `DOMContentLoaded`
* é¿å…è¯»å– `undefined` çš„ `__userGEO`

---

## âœ… ä¼˜åŒ–æ–¹å¼äºŒï¼šè½®è¯¢æ£€æŸ¥ `__userGEO` çš„å¯ç”¨æ€§

å¦‚æœä½ æ— æ³•æ§åˆ¶ `location` è„šæœ¬çš„æ³¨å…¥æ–¹å¼æˆ–æ—¶æœºï¼Œå¯ä»¥ä½¿ç”¨è½®è¯¢æ–¹å¼ç­‰å¾…å˜é‡å°±ç»ªï¼š

```html
<script define:vars={{ lang }}>
  const waitForUserGEO = new Promise((resolve) => {
    const check = () => {
      if (window.__userGEO?.company) {
        resolve(window.__userGEO.company)
      } else {
        setTimeout(check, 50)
      }
    }
    check()
  })

  waitForUserGEO.then((company) => {
    if (company !== 'company1' && company !== 'company2') {
      window.location.href = 'https://www.mywonderfulsite.com/'
      return
    }

    const scriptElement = document.createElement('script')
    scriptElement.src = '/rw.js'
    scriptElement.setAttribute('company', company)
    scriptElement.setAttribute('lang', '{{ lang }}')
    document.head.appendChild(scriptElement)
  })
</script>
```

### âœ… ä¼˜ç‚¹ï¼š

* ä¸ä¾èµ–ä»»ä½• DOM äº‹ä»¶
* é€šç”¨ã€å…¼å®¹æ€§å¥½

### âš ï¸ ç¼ºç‚¹ï¼š

* æœ‰è½»å¾®æ€§èƒ½å¼€é”€ï¼ˆè½®è¯¢ï¼‰

---

## âœ… ä¼˜åŒ–æ–¹å¼ä¸‰ï¼šå°è£…æˆ `loadScript` å·¥å…·å‡½æ•°

æ¨¡å—åŒ–åœ°åŠ è½½å¹¶ç­‰å¾… script å®Œæˆï¼š

```js
function loadScript(src) {
  return new Promise((resolve, reject) => {
    const s = document.createElement('script')
    s.src = src
    s.onload = resolve
    s.onerror = reject
    document.head.appendChild(s)
  })
}

loadScript('https://www.mywonderfulsite.com/api/location')
  .then(() => {
    const company = window.__userGEO?.company || 'company1'
    if (company !== 'company1' && company !== 'company2') {
      window.location.href = 'https://www.mywonderfulsite.com/'
      return
    }

    const rwScript = document.createElement('script')
    rwScript.src = '/rw.js'
    rwScript.setAttribute('company', company)
    rwScript.setAttribute('lang', '{{ lang }}')
    document.head.appendChild(rwScript)
  })
  .catch((err) => {
    console.error('Failed to load location script', err)
  })
```

---

## âœ… ä¼˜åŒ–æ–¹å¼å››ï¼ˆæœ€ä½³ä½†éœ€åç«¯æ”¯æŒï¼‰ï¼šæœåŠ¡ç«¯é¢„å¤„ç† GEO æ•°æ®

å¦‚æœä½ çš„æœåŠ¡ç«¯èƒ½é¢„è°ƒç”¨ GEO APIï¼ˆä¾‹å¦‚é€šè¿‡ SSR æˆ– edge middlewareï¼‰ï¼Œå¯ä»¥ç›´æ¥æŠŠç”¨æˆ·ä½ç½®æ•°æ®å†™è¿›é¡µé¢ï¼š

```html
<script>
  window.__userGEO = { company: "company1" } // æœåŠ¡å™¨æ³¨å…¥
</script>
```

é…åˆå‰ç«¯åŒæ­¥ä½¿ç”¨ï¼š

```js
const company = window.__userGEO?.company || 'company1'
```

### âœ… ä¼˜ç‚¹ï¼š

* æ€§èƒ½æœ€ä½³ï¼ˆæ— å¼‚æ­¥ç­‰å¾…ï¼‰
* æ›´æ˜“ç¼“å­˜å’Œè°ƒè¯•

---

## ğŸ§  æ€»ç»“å¯¹æ¯”

| æ–¹æ³•                | å¯æ§æ€§ | æ€§èƒ½ | å¤æ‚åº¦    | é€‚ç”¨åœºæ™¯               |
| ----------------- | --- | -- | ------ | ------------------ |
| `<script onload>` | é«˜   | é«˜  | ä½      | ä½ èƒ½æ§åˆ¶ `<script>` æ³¨å…¥ |
| `è½®è¯¢æ£€æŸ¥å˜é‡`          | ä¸­   | ä¸­  | ä¸­      | è„šæœ¬ä¸å¯æ§              |
| `loadScript å°è£…`   | é«˜   | é«˜  | ä¸­      | å¤šè„šæœ¬å¤ç”¨              |
| `SSR æ³¨å…¥å˜é‡`        | æœ€ä½³  | æœ€ä½³ | é«˜ï¼ˆéœ€åç«¯ï¼‰ | æœ‰æœåŠ¡ç«¯æ”¯æŒ             |

---

## ğŸ§© å®æˆ˜å»ºè®®

* å¦‚æœä½ èƒ½æ§åˆ¶ `<script>` æ³¨å…¥æ–¹å¼ï¼Œ**ä½¿ç”¨ `.onload` æ˜¯æœ€ç®€æ´ä¸”é«˜æ•ˆçš„è§£å†³æ–¹æ¡ˆ**ã€‚
* è‹¥ä¾èµ–ç¬¬ä¸‰æ–¹æ³¨å…¥ã€å˜é‡æœªçŸ¥æ—¶æœºï¼Œ**ä½¿ç”¨è½®è¯¢æˆ– `Promise + setTimeout` æ›´åŠ å¥å£®**ã€‚
* èƒ½æ”¹åç«¯ï¼Ÿé‚£å°±ç›´æ¥æ³¨å…¥ `__userGEO`ï¼Œ**å‰ç«¯é›¶ç­‰å¾…ï¼Œä½“éªŒæ‹‰æ»¡ã€‚**
